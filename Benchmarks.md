# 基准测试 (Benchmarks)
本次基准测试的主要目的是：在多个维度上，对不同技术方案做对比，以便于为技术选型提供一个重要的参考指标。

## 一、测试环境
**项目：** 通过不同技术方案实现同样的功能并具备服务端渲染的能力：view-mvc（传统服务端MVC）、view-nuxt（Nuxt.js框架）、view-spa（Puppeteer渲染SPA）、view-ssr（SSR脚手架）

**机器：** MacBook Pro (15-inch, 2018), 2.2 GHz Intel Core i7, 16 GB 2400 MHz DDR4, 256G SSD

**网络：** 为避免网络波动的影响，直接在本机对环回地址进行压力测试，在实际的网络环境里QPS/TPS会更低

**方法：** 模拟100个用户同时访问，每个用户访问100次，共产生10000次请求来评估应用的性能

**实现：** `autocannon -a 10000 -c 100 -p 1 -t 60 http://localhost:{port}{path}`

## 二、测试维度
**按页面分为：** `/posts`（请求接口并渲染数据） 和 `/about`（静态渲染）

**按缓存分为：** 开启缓存 和 关闭缓存 （页面级缓存）

**按实例分为：** 1个实例 和 4个实例 （通过[PM2](https://pm2.io/doc/en/runtime/overview/)来启动项目）

## 三、测试结果
**分组一、启动1个实例、关闭缓存，对 `/posts` 压测**

| 应用名称 | 实例(个) | 路径 | 是否缓存 | CPU | MEM | 平均耗时(ms) | QPS/TPS | 备注 |
| :------ | :-----: | :--- | :----: | --: | --: | ----------: | ------: | :--- |
| view-mvc | 1 | `/posts` | 否 | ±120% | ±100M | 416.84 | 204.03 | - |
| view-nuxt | 1 | `/posts` | 否 | ±120% | ±190M | 907.72 | 107.52 | - |
| view-spa | 1 | `/posts` | 否 | ±60% | ±100M | 19340.02 | 4.93 | 系统内存占用约14G，Puppeteer线程保持在85个左右 |
| view-ssr | 1 | `/posts` | 否 | ±120% | ±130M | 529.96 | 185.19 | - |

_注：_由于`view-spa`压起来太慢，故将请求数量降为1000

**分组二、启动1个实例、关闭缓存，对 `/about` 压测**

| 应用名称 | 实例(个) | 路径 | 是否缓存 | CPU | MEM | 平均耗时(ms) | QPS/TPS | 备注 |
| :------ | :-----: | :--- | :----: | --: | --: | ----------: | ------: | :--- |
| view-mvc | 1 | `/about` | 否 | ±120% | ±100M | 34.21 | 2500.75 | - |
| view-nuxt | 1 | `/about` | 否 | ±120% | ±170M | 183.46 | 500.00 | - |
| view-spa | 1 | `/about` | 否 | ±60% | ±100M | 18105.51 | 5.24 | 系统内存占用约14G，Puppeteer线程保持在85个左右 |
| view-ssr | 1 | `/about` | 否 | ±120% | ±110M | 81.53 | 1000.00 | - |

_注：_由于`view-spa`压起来太慢，故将请求数量降为1000

**分组三、启动1个实例、启用缓存，对 `/posts` 压测**

| 应用名称 | 实例(个) | 路径 | 是否缓存 | CPU | MEM | 平均耗时(ms) | QPS/TPS | 备注 |
| :------ | :-----: | :--- | :----: | --: | --: | ----------: | ------: | :--- |
| view-mvc | 1 | `/posts` | 是 | - | - | 14.32 | 5000.50 | - |
| view-nuxt | 1 | `/posts` | 是 | - | - | 26.83 | 3333.67 | - |
| view-spa | 1 | `/posts` | 是 | - | - | 11.27 | 5000.00 | - |
| view-ssr | 1 | `/posts` | 是 | - | - | 24.17 | 3334.34 | - |

**分组四、启动1个实例、启用缓存，对 `/about` 压测**

| 应用名称 | 实例(个) | 路径 | 是否缓存 | CPU | MEM | 平均耗时(ms) | QPS/TPS | 备注 |
| :------ | :-----: | :--- | :----: | --: | --: | ----------: | ------: | :--- |
| view-mvc | 1 | `/about` | 是 | - | - | 10.53 | 5000.50 | - |
| view-nuxt | 1 | `/about` | 是 | - | - | 18.26 | 3334.67 | - |
| view-spa | 1 | `/about` | 是 | - | - | 8.89 | 10004.00 | - |
| view-ssr | 1 | `/about` | 是 | - | - | 9.61 | 5002.00 | - |

**分组五、启动4个实例、关闭缓存，对 `/posts` 压测**

| 应用名称 | 实例(个) | 路径 | 是否缓存 | CPU | MEM | 平均耗时(ms) | QPS/TPS | 备注 |
| :------ | :-----: | :--- | :----: | --: | --: | ----------: | ------: | :--- |
| view-mvc | 4 | `/posts` | 否 | ±60% | ±100M | 454.89 | 217.40 | - |
| view-nuxt | 4 | `/posts` | 否 | ±120% | ±160M | 467.80 | 200.00 | - |
| view-spa | 4 | `/posts` | 否 | ±60% | ±100M | 21022.02 | 4.59 | 系统内存占用约15G，Puppeteer线程保持在117个左右 |
| view-ssr | 4 | `/posts` | 否 | ±120% | ±100M | 381.88 | 203.80 | - |

_注： 由于`view-spa`压起来太慢，故将请求数量降为1000_

**分组六、启动4个实例、关闭缓存，对 `/about` 压测**

| 应用名称 | 实例(个) | 路径 | 是否缓存 | CPU | MEM | 平均耗时(ms) | QPS/TPS | 备注 |
| :------ | :-----: | :--- | :----: | --: | --: | ----------: | ------: | :--- |
| view-mvc | 4 | `/about` | 否 | ±60% | ±100M | 11.78 | 5000.00 | - |
| view-nuxt | 4 | `/about` | 否 | ±120% | ±140M | 69.33 | 1250.00 | - |
| view-spa | 4 | `/about` | 否 | ±60% | ±100M | 21022.02 | 4.74 | 系统内存占用约15G，Puppeteer线程保持在117个左右 |
| view-ssr | 4 | `/about` | 否 | ±120% | ±100M | 37.98 | 2000.40 | - |

_注： 由于`view-spa`压起来太慢，故将请求数量降为1000_

**分组七、启动4个实例、启用缓存，对 `/posts` 压测**

| 应用名称 | 实例(个) | 路径 | 是否缓存 | CPU | MEM | 平均耗时(ms) | QPS/TPS | 备注 |
| :------ | :-----: | :--- | :----: | --: | --: | ----------: | ------: | :--- |
| view-mvc | 4 | `/posts` | 是 | - | - | 6.87 | 10004.00 | - |
| view-nuxt | 4 | `/posts` | 是 | - | - | 9.78 | 5001.50 | - |
| view-spa | 4 | `/posts` | 是 | - | - | 4.88 | 10004.00 | - |
| view-ssr | 4 | `/posts` | 是 | - | - | 9.38 | 5000.00 | - |

**分组八、启动4个实例、启用缓存，对 `/about` 压测**

| 应用名称 | 实例(个) | 路径 | 是否缓存 | CPU | MEM | 平均耗时(ms) | QPS/TPS | 备注 |
| :------ | :-----: | :--- | :----: | --: | --: | ----------: | ------: | :--- |
| view-mvc | 4 | `/about` | 是 | - | - | 5.42 | 10004.00 | - |
| view-nuxt | 4 | `/about` | 是 | - | - | 7.42 | 10004.50 | - |
| view-spa | 4 | `/about` | 是 | - | - | 4.36 | 10004.00 | - |
| view-ssr | 4 | `/about` | 是 | - | - | 5.95 | 10004.00 | - |

## 四、结果分析
**结论一、开启缓存**

不管启动单实例还是多实例，在使用缓存情况下，对 `/posts` 页面压测，得出：

* `view-mvc` 和 `view-spa` 的QPS/TPS基本相等
* `view-ssr` 和 `view-nuxt` 的QPS/TPS基本相等，都低于前两者，大概是因为后两者是由Express驱动的原因

在缓存的情况下对比各个方案，其实并没有太大意义，之所以加入缓存纬度的测试，是为了对比在非缓存情况下有多大提升！

接下来看看，在关闭缓存情况下，它们的表现！

**结论二、启动1个实例**

关闭缓存的情况下，对 `/posts` 页面压测，差距没有被拉的太开：

* `view-ssr` 和 `view-mvc` 的QPS/TPS并没有差太多
* `view-nuxt` 的QPS/TPS低于前两者接近一半
* `view-spa` 的QPS/TPS超级低，响应时间也无比慢，还非常消耗内存

关闭缓存的情况下，对 `/about` 页面压测，差距出来了：

* `view-mvc` 的QPS/TPS是 `view-ssr` 的2.5倍
* `view-ssr` 的QPS/TPS是 `view-nuxt` 的2倍
* `view-spa` 的QPS/TPS超级低，响应时间也无比慢，还非常消耗内存

_注：纯静态渲染的场景并不多，如果忽略此项测试，它们的差距也没那么大_

**结论三、启动4个实例**

关闭缓存的情况下，对 `/posts` 页面压测，差距没有被拉的太开：

* `view-nuxt` 的QPS/TPS提上来了，和 `view-ssr` 相近
* `view-mvc` 的QPS/TPS略优于前两者，不太应该啊！应该更好才对
* `view-spa` 的QPS/TPS超级低，响应时间也无比慢，还非常消耗内存

关闭缓存的情况下，对 `/about` 页面压测，差距出来了：

* `view-mvc` 的QPS/TPS是 `view-ssr` 的2.5倍
* `view-ssr` 的QPS/TPS是 `view-nuxt` 的1.6倍
* `view-spa` 的QPS/TPS超级低，响应时间也无比慢，还非常消耗内存

_注：纯静态渲染的场景并不多，如果忽略此项测试，它们的差距也没那么大_

**结论四、排名**

如果在性能上给各个技术方案排个先后，那么它们的顺序如下：

**view-mvc：** 第一名！当之无愧，此方案已经是一个久经考验的成熟方案了

**view-ssr：** 第二名！前后端分离后，作为一个SPA在SEO方面的补充方案，值得尝试

**view-nuxt：** 第三名！本以为此方案会优于第二名，真是不测不知道啊！哈哈～但开发体验不错，推荐使用

**view-spa：** 第四名！这是一个很有意思的方案，有种另辟蹊径的感觉！也许是大家觉得不用尝试就已经知道它性能不好了

排名只是作为一个参考，还得根据具体的业务场景来选用一个合适的技术方案！
